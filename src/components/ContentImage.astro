---
/**
 * ContentImage component - Optimized image component for MDX content
 *
 * Usage in MDX:
 * <ContentImage src="/best-practices/image.webp" alt="Description" width="60%" />
 *
 * This component automatically loads images from src/assets/content/ and applies
 * Astro's image optimization. Falls back to regular img tag if image not found.
 */
import { Image } from 'astro:assets';

// Import all images from src/assets/content for optimization (exclude GIFs - they can exceed pixel limits)
const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/assets/content/**/*.{webp,png,jpg,jpeg}', { eager: true });

interface Props {
  src: string;
  alt?: string;
  width?: string;
  style?: string;
  class?: string;
}

const { src, alt = '', width, style, class: className } = Astro.props;

// Helper to get optimized image from path
function getOptimizedImage(srcPath: string): ImageMetadata | null {
  // Convert /folder/image.webp to /src/assets/content/folder/image.webp
  const assetPath = `/src/assets/content${srcPath}`;
  const imageModule = allImages[assetPath];
  return imageModule?.default || null;
}

const optimizedImage = getOptimizedImage(src);

// Build inline style string
let inlineStyle = style || '';
if (width) {
  // If width doesn't include a unit, assume percentage for backwards compatibility
  const widthValue = width.includes('%') || width.includes('px') || width.includes('rem') || width.includes('em')
    ? width
    : width;
  inlineStyle = inlineStyle ? `${inlineStyle}; max-width: ${widthValue}` : `max-width: ${widthValue}`;
}
---

{optimizedImage ? (
  <Image
    src={optimizedImage}
    alt={alt}
    style={inlineStyle || undefined}
    class={className}
  />
) : (
  <img
    src={src}
    alt={alt}
    style={inlineStyle || undefined}
    class={className}
    loading="lazy"
  />
)}
